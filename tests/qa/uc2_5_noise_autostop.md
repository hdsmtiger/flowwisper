# UC2.5 噪音检测与静默自动结束 QA 清单

## 目的
验证桌面端在 macOS 与 Windows 环境下的噪音突增提醒、静默倒计时与自动结束行为是否满足 PRD UC2.5 要求，并确认离线状态与多次触发情况下的可靠性。

## 覆盖范围
- Flowwisper Desktop 应用（Tauri + React）
- Core Service 音频检测、会话事件、遥测写入
- macOS 13+/Windows 11（含 USB/蓝牙麦克风）

## 前置条件
1. 安装最新构建（带有噪音检测功能）的 Flowwisper Desktop。
2. 完成设备校准（可复位到默认基线）。
3. 准备两种录音环境：
   - 安静室内（背景噪音 < 40 dB）。
   - 可控制噪音的播放设备（如手机或音响，用于制造 >15 dB 突增）。
4. 关闭除系统录音必需外的其他音频应用，确保麦克风独占。
5. 准备秒表或计时工具，用于验证倒计时准确性。

## 测试矩阵
| 场景 ID | 设备 | 网络状态 | 麦克风类型 | 预期结果摘要 |
| --- | --- | --- | --- | --- |
| M-01 | macOS | 联机 | 内建麦克风 | 噪音条幅在噪音突增 200 ms 内出现，2 秒冷却生效 |
| M-02 | macOS | 联机 | 蓝牙耳机 | 静默倒计时 3→2→1 显示准确，5 秒结束会话 |
| M-03 | macOS | 离线 | 内建麦克风 | 离线仍显示噪音与静默提示，结果正常保存 |
| W-01 | Windows | 联机 | USB 麦克风 | 倒计时中重新说话取消提示并恢复录音 |
| W-02 | Windows | 联机 | 内建麦克风 | 倒计时期间手动结束，显示“手动结束”取消原因 |
| W-03 | Windows | 离线 | USB 麦克风 | 自动结束后遥测入队（通过开发者工具检查） |

> 若资源有限，可优先执行 M-01、M-02、W-01、W-02，并在回归时补全离线场景。

## 场景详情

### M-01 噪音条幅及时出现（macOS 内建麦克风）
1. 在安静环境中启动录音并持续说话 5 秒，确认无噪音条幅。
2. 靠近麦克风播放白噪或敲击桌面，使音量瞬间提升 ≥15 dB。
3. 观察浮层顶部是否在 200 ms 内出现黄色条幅，文案为“噪音偏高，请调整环境或启用强降噪”。
4. 保持噪音 1 秒后停止，确认条幅在噪音消失后仍至少保留 1 秒然后淡出。
5. 在 2 秒冷却期内再次制造噪音，确认不会重复弹出条幅；2 秒后恢复可再次触发。

### M-02 静默自动结束（macOS 蓝牙耳机）
1. 使用蓝牙耳机连接 Mac 并重新运行设备校准。
2. 启动录音，正常说话 3 秒后停止。
3. 记录浮层中央的倒计时是否在静默 2 秒后出现，并按 3→2→1→0 顺序更新。
4. 倒计时期间保持静默，确认在 5 秒整时自动结束会话并切换到“转写完成”卡片。
5. 检查历史记录中是否保存本次转写，并确认自动结束事件写入遥测（可通过开发者菜单或日志查看）。

### M-03 离线模式行为（macOS 内建麦克风）
1. 断开网络（关闭 Wi-Fi 或启用飞行模式）。
2. 重启应用并启动录音，重复 M-01 中的噪音触发步骤。
3. 确认在离线状态下仍能显示噪音条幅与静默倒计时，并在静默满 5 秒后自动结束。
4. 恢复网络后，检查遥测是否上报（可查看日志队列状态或上传记录）。

### W-01 倒计时被讲话取消（Windows USB 麦克风）
1. 在 Windows 设备上连接 USB 麦克风并完成校准。
2. 开始录音，正常说话 3 秒后静默触发倒计时。
3. 当倒计时显示“2 秒”时重新讲话 ≥1 秒。
4. 预期倒计时立即取消，浮层恢复录音状态且不会自动结束。
5. 查看 UI 是否显示“已取消静默倒计时（检测到讲话）”提示或等效文案。

### W-02 手动结束覆盖倒计时（Windows 内建麦克风）
1. 启动录音并静默触发倒计时。
2. 在倒计时显示“1 秒”时点击浮层“完成”按钮或再次按 Fn 键。
3. 确认会话立即结束，且不会额外出现自动结束弹窗。
4. 在开发者日志或遥测查看器中确认取消原因标记为 `manual_stop`。

### W-03 离线遥测排队（Windows USB 麦克风）
1. 断开网络，启动录音并重复 W-01、W-02 场景各一次，触发噪音条幅与静默倒计时自动结束。
2. 打开应用提供的遥测调试视图或通过 CLI 查询 `telemetry_queue`（`sqlite3 telemetry.db "select type,status from telemetry_queue"`）。
3. 验证噪音与静默事件已排队但状态为“pending_upload”，队列未超过 300 条。
4. 恢复网络并等待后台同步，确认队列清空或条目状态变为“uploaded”。

## 回归与记录要求
- 每个场景执行后，在 QA 表格中记录“通过/失败/阻塞”、设备信息、麦克风型号、噪音来源。
- 若出现误报或迟滞 >500 ms，请附带日志文件与音频环境说明。
- 回归周期：
  - 噪音条幅与静默倒计时：每次桌面版本发版前回归一次。
  - 遥测离线队列：每个小版本或数据库 schema 更新后验证一次。

## 附录
- 噪音阈值：默认 `baseline + 15 dB`，静默阈值 `baseline − 10 dB`，倒计时 5 秒。
- 相关日志位置：`core/logs/session.log`（噪音/静默事件 INFO）、`core/logs/session_debug.log`（取消原因）。
- 遥测数据库：`~/Library/Application Support/Flowwisper/telemetry.db` (macOS)、`%APPDATA%\Flowwisper\telemetry.db` (Windows)。
