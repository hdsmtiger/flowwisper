# PRD: UC2.5 噪音检测与自动结束

## 1. 概述
UC2.5 旨在为 Fn 语音输入流程补齐“录音中噪音突增提醒”与“静默自动结束”能力。当环境噪音突然升高或用户长时间不讲话时，系统需及时提示用户调整环境，并在符合静默阈值时自动结束会话、触发转写结果保存。该能力依托核心守护进程的音频分析链路与桌面浮层的实时反馈，帮助用户在复杂场景中保持输入质量、避免无效录音与拖延结束，提高会话准确性与效率。

## 2. 目标
1. 在录音阶段实时检测噪音突增（> 环境基线 + 15 dB）与静默（≥ 5 秒），并于 200 ms 内反馈到桌面浮层，提示用户当前状态。
2. 当静默持续超过阈值时，自动结束会话并直接进入“转写完成”态，确保润色稿在既有发布流程中落地且成功率 ≥ 99%。
3. 将噪音触发与静默结束事件写入遥测（含时间戳、阈值、会话 ID），用于后续对阈值与模型的调优，事件丢失率 < 1%。
4. 在 macOS 与 Windows 桌面环境、含离线模式下保持一致行为，不依赖外部网络资源即可完成检测与反馈。

## 3. 用户故事
- 作为在开放办公区工作的产品经理，我希望系统在背景噪音突然增大时即刻提醒，让我暂停讲话或启用降噪，避免错误转写。
- 作为在会议中记录纪要的用户，我希望在结束讲话后系统能检测静默并自动结束录音，省去再次按键的步骤，并确保结果直接保存。
- 作为经常切换网络状态的远程工作者，我希望即便在离线模式下，噪音提示与自动结束仍能生效，不影响录音流程。
- 作为桌面应用 QA，我需要通过遥测回溯噪音触发与静默结束的次数和阈值，判断是否存在误报或漏报，以便优化算法。

## 4. 功能性需求
1. **噪音基线与检测**
   1. 会话进入 `PreRoll` 时读取设备校准生成的环境噪音基线（默认取 Device Calibration Manager 最近一次的均值），若无数据则在前 500 ms 采样计算滚动均值。
   2. 在 `Recording` 阶段以 100 ms 粒度计算短时能量/SNR，超过基线 + 15 dB 且持续 ≥ 300 ms 时判定为噪音突增事件；需去抖动避免连续提示（同一事件冷却 2 秒）。
   3. 噪音突增事件触发后，UI 浮层顶部出现黄色条幅，包含文案“检测到噪音偏高，请调整环境或启用强降噪”，仅以视觉提示呈现，不播放提示音或触觉反馈。
   4. 若用户已开启强降噪模式或设备自动增益，提示文案追加当前模式标签，帮助用户判断是否需要进一步处理。

2. **静默识别与倒计时**
   1. 当语音能量低于静默阈值（< 基线 − 10 dB）持续 2 秒后，浮层以视觉方式展示静默倒计时（例如“3 秒后自动结束”），倒计时数字需实时更新。
   2. 静默持续满 5 秒时，系统自动触发结束会话，与用户手动按 Fn 键效果一致，进入 `Processing` → `Publishing` → `Completed` 状态机流程。
   3. 自动结束后不再弹出额外确认框，也不播放声音，直接显示既有“转写完成”卡片，并按默认逻辑插入润色稿/保存结果。
   4. 自动结束事件需防止误触：若在倒计时期间检测到重新说话（能量回升至阈值以上持续 ≥ 300 ms），立即取消倒计时并恢复 `Recording` 状态。

3. **状态同步与日志**
   1. Core Service 需通过 Session State 通道向 UI 推送 `NoiseWarning`、`SilenceCountdown`、`AutoStop` 三类事件，事件载荷包含当前声级、剩余秒数等信息。
   2. 当 UI 收到 `NoiseWarning` 时显示条幅；`SilenceCountdown` 时显示倒计时；`AutoStop` 时隐藏录音 UI 并展示结果卡片。
   3. 每次噪音触发、静默倒计时开始、自动结束和取消都应记录在 Core 日志中，日志级别分别为 `INFO`（成功触发）与 `DEBUG`（取消/恢复）。

4. **遥测数据**
   1. 噪音突增事件：记录会话 ID、发生时间、计算出的阈值（基线 + 15 dB）、实际声级、是否在强降噪模式下发生。
   2. 静默自动结束事件：记录会话 ID、倒计时时长、是否被取消、最终结束时刻；若取消，则额外记录取消原因（重新说话/手动结束）。
   3. 遥测事件需在本地离线队列缓存，等待网络可用时批量上报；确保队列容量足以缓存至少 100 次事件，避免离线期间数据丢失。

5. **离线与兼容性**
   1. 噪音与静默检测在本地音频处理线程完成，不依赖云端模型；当网络不可用或切换离线模式时，提示与自动结束逻辑保持不变。
   2. 支持 macOS（Intel/Apple Silicon）与 Windows（x64）桌面设备，兼容内建麦克风、USB/蓝牙设备；切换输入设备后需重建基线。
   3. 若设备不支持实时能量检测（API 不可用），需记录错误并回退为手动结束，仅提示“无法读取噪音电平”。

## 5. 非目标
- 本迭代不提供用户自定义噪音/静默阈值，沿用默认基线 +15 dB 和静默 5 秒策略；相关设置将在后续设置模块扩展。
- 不提供提示音、震动或系统通知等额外提醒，仅使用桌面浮层视觉提示。
- 不实现自动恢复录音或二次确认弹窗，自动结束后即进入结果流程。
- 不缓存音频片段或生成噪音样本供诊断，所有检测仅基于实时分析。
- 不处理移动端或浏览器扩展场景，仅聚焦桌面端核心流程。

## 6. 设计考量
- 浮层视觉语言沿用实时转写的现有样式：噪音提示使用黄色强调条，与架构文档中“红色=爆音”的声波逻辑一致，确保用户可快速识别。
- 静默倒计时应位于浮层顶部或中央显眼位置，提供 3-2-1 逐步减淡动画，同时保留实时声波以帮助用户判断输入状态。
- 提供辅助功能支持：在字幕模式下同时显示文字提示“噪音偏高”“3 秒后自动结束”，确保听障用户可见。
- 在深色模式下保持足够对比度，避免黄色提示过亮；遵循桌面 UI 的 12px 边距与 4px 圆角规范。
- 当噪音提示持续存在时，允许用户通过浮层的“更多”菜单跳转到设置的强降噪选项（若已实现），但不在本迭代中新增交互。

## 7. 技术考量
- 音频分析模块复用现有的 `AudioIngestor`/`Device Calibration Manager` 管线，采用滑动窗口均值与标准差判断噪音突增；需在 Rust 守护进程中以非阻塞方式实现，避免影响 100-200 ms 的音频推送周期。
- Session State Manager 扩展事件枚举，确保 Tauri 桥接层可序列化发送至前端；前端 TypeScript SDK 更新对应事件类型与处理回调。
- UI 层需新增 React hook/状态管理，监听噪音与静默事件并驱动提示组件；单元测试覆盖提示出现/取消、倒计时恢复等逻辑。
- 遥测模块新增事件 `noise_warning_triggered`、`silence_autostop_triggered`、`silence_autostop_canceled`，沿用 OpenTelemetry schema，与现有会话 ID 关联。
- 确保检测逻辑在低功耗设备上不会显著增加 CPU（目标额外占用 < 5%）；必要时在强降噪模式下降级检测频率。
- 错误处理：当音频缓冲延迟导致检测失真时记录 `WARN`，并在 UI 显示“噪音检测暂不可用”提示，避免误导用户。

## 8. 成功指标
- 噪音突增被识别并提示的准确率 ≥ 90%（以人工标注样本评估），误报率 ≤ 5%。
- 静默自动结束触发后，转写结果在 2 秒内进入“完成”态，整体成功率 ≥ 99%。
- QA 脚本在 macOS 与 Windows 上验证 20 次噪音/静默场景，事件遥测记录齐全且无丢失。
- 发布两周内，因噪音未提示或静默未自动结束产生的用户工单 < 3 起。

## 9. 未解问题
- 是否需要在设置页预埋阈值开关（仅显示默认值）以便未来开放自定义？
- 噪音提示是否需要在通知中心保留历史记录，供用户事后查看？
- 当自动结束后用户立即继续讲话时，是否提供快速重新开始的交互（例如自动弹出“重新录制”按钮）？
- 是否需要在遥测中记录设备型号或驱动版本，以便排查特定硬件的误报？
