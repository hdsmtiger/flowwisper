# PRD: UC2.3 会话结束与插入目标执行

## 1. 概述
本 PRD 聚焦 Sprint 2 的 UC2.3「会话结束与插入目标执行」。当用户停止语音输入（手动按 Fn 键或自动静默结束）后，系统需展示结果卡片并在桌面任意可编辑应用中稳定完成文本落地。核心目标是确保润色稿在绝大多数情况下直接插入当前光标位置，同时为复制剪贴板与保存片段草稿提供可靠选项，覆盖常见应用场景并给出明确的撤销/失败反馈。【F:docs/sprint/sprint2.md†L13-L20】【F:docs/architecture.md†L120-L172】【F:docs/voice_fn_transcriber_prd.md†L60-L123】

## 2. 目标
1. 默认将完整润色稿插入当前光标位置，并在 0.5 秒内展示“已插入，可撤销”提示，帮助用户快速确认写入结果并进行撤销操作。
2. 提供可选的“复制到剪贴板”“保存为片段草稿”动作，并在通知中心记录成功状态，方便用户追溯与复用。
3. 针对不同桌面应用的输入框，确保会话结束到文本落地的成功率 ≥ 99%，其中直接插入到光标位置的成功率需达到 99%，失败时暴露重试与降级路径。
4. 在会话结束卡片中统一呈现插入进度、失败原因与重试入口，保持状态机体验一致且可访问。

## 3. 用户故事
- 作为一名桌面端知识工作者，我完成语音输入后，希望润色稿自动粘贴到正在编辑的文档光标处，并且弹出可撤销提示，以便立即继续写作。【F:docs/voice_fn_transcriber_prd.md†L94-L123】
- 作为一名需要跨应用搬运内容的用户，我希望可以改为复制润色稿到剪贴板，并在通知中心看到“复制成功”的记录，以便切换应用后粘贴。
- 作为一名经常整理常用话术的用户，我希望在结果卡片中一键将当前稿件保存为片段草稿，并能在历史/通知中心快速查看保存结果。
- 作为一名担心插入失败的用户，我希望当系统无法识别目标输入框或粘贴出错时，界面立即提醒并提供重试、复制或草稿保存的备选方案。

## 4. 功能性需求
1. **会话完成判定**：当用户松开 Fn、点击“完成”或静默达到阈值时，Session State Manager 从 `Processing` 进入 `Publishing`，触发结果卡片展示，并锁定当前焦点应用与插入上下文信息。【F:docs/architecture.md†L173-L211】
2. **结果卡片内容**：卡片需至少包含：
   1. 润色稿全文（默认展示，可切换到原始稿供比对）。
   2. 三个操作入口：“插入光标”“复制剪贴板”“保存片段草稿”。
   3. 当前焦点应用/输入框识别状态（正常、未知、不可编辑）。
   4. 插入或复制进度反馈与撤销提示位置。
3. **默认插入流程**：
   1. 在进入 `Publishing` 时自动触发“插入光标”流程，先检测前景应用是否允许粘贴（Accessibility API/Windows UI Automation）。
   2. 若检测通过，在 400ms 内调用粘贴指令（或模拟键入）写入润色稿。
   3. 插入完成后 100ms 内通过 HUD 显示“已插入，按 ⌘Z/CTRL+Z 撤销”提示，并保持 3 秒可视。
4. **插入失败处理**：
   1. 若粘贴指令返回失败或 1 秒未检测到文本变化，标记失败并弹出错误文案（含原因：无焦点、权限受限、应用拒绝等）。
   2. 失败时默认改为复制至剪贴板，同时展示“插入失败，已复制，可手动粘贴”提示。
   3. 卡片提供“重试插入”按钮，可重新检测焦点并再次执行插入；连续 2 次失败则推荐用户切换目标或保存草稿。
5. **剪贴板复制**：
   1. 用户手动点击“复制剪贴板”时，即刻复制润色稿，并在卡片与通知中心展示“复制成功”记录。
   2. 支持格式保持（纯文本）并保留上一份剪贴板内容的备份，供撤销时恢复。
6. **片段草稿保存**：
   1. 点击“保存片段草稿”弹出标题与标签输入框（默认使用会话时间戳 + 前 20 个字符）。
   2. 保存成功写入本地加密 SQLite，并在通知中心生成条目；失败提供重试与导出日志选项。【F:docs/architecture.md†L63-L118】【F:docs/architecture.md†L242-L278】
7. **通知中心记录**：所有成功/失败动作需写入通知中心（含时间、动作类型、结果），支持后续审计与用户回顾。【F:docs/sprint/sprint2.md†L17-L20】
8. **可访问性与键盘操作**：结果卡片必须支持键盘导航（Tab/Enter/Space）与屏幕阅读器朗读操作按钮、状态反馈。
9. **多语言支持**：插入提示与错误消息需根据当前应用语言设置选择中英文，保持与实时转写一致的本地化策略。
10. **遥测与日志**：在 Core Service 记录插入尝试、成功/失败原因、重试次数与剪贴板备份事件，至少保留最近 7 天以便排查。

## 5. 非目标
- 本迭代不实现跨设备同步片段草稿（仅本地存储），也不提供通知中心 UI 的增量改版。
- 不处理特定应用的深度集成（如直接调用 Slack/Teams API），仍以内联粘贴为主。
- 不实现云端重放或远程插入功能。
- 不覆盖移动端或浏览器插件场景，仅限桌面端 Tauri 应用。

## 6. 设计考量
- 结果卡片沿用语音浮层的视觉体系，状态色遵循架构文档中的 HUD 约定（绿色=成功、黄色=待重试、红色=失败）。【F:docs/architecture.md†L173-L211】
- 默认插入执行期间展示细微进度条或旋转动画，避免用户误以为系统已卡死。
- 撤销提示采用轻量通知条形式，位置固定在卡片底部或光标附近，确保不遮挡重要内容。
- 在无焦点输入框场景下，需突出醒目的引导文案（如“请点击目标输入框后重试”）。

## 7. 技术考量
- Core Service 需调用操作系统辅助功能接口检测焦点窗口类型，若检测失败或权限不足，提前弹出系统权限引导提示。【F:docs/architecture.md†L173-L211】
- 粘贴实现应优先调用原生粘贴 API；若目标应用禁用粘贴，则回退到模拟键入，并对长度 > 2000 字符的文本执行分段输入以防被截断。
- 剪贴板备份与恢复应复用 Persistence Layer，保留一份最近成功粘贴前的内容，用户撤销时自动恢复。【F:docs/architecture.md†L96-L118】
- 片段草稿保存使用 SQLCipher 加密存储，并通过 Persistence Layer 暴露 API；保存动作需异步执行，防止阻塞 UI。【F:docs/architecture.md†L242-L278】
- 遥测事件与通知中心记录通过 Telemetry 模块与本地队列持久化，确保在应用崩溃时仍可追踪失败原因。

## 8. 成功指标
- 会话结束后 95% 的插入提示在 0.5 秒内出现，直接插入到光标位置的成功率 ≥ 99%；触发降级到剪贴板复制的场景需记录原因并指导用户完成粘贴。
- 插入失败后提供的自动复制降级，需在 200ms 内完成并展示提示。
- 片段草稿保存成功率 ≥ 98%，失败均记录可追踪日志。
- 相关用户投诉/bug（与插入失败或缺乏提示相关）在上线后二周内 < 2% 活跃会话。

## 9. 未解问题
- 是否需要在设置中允许用户关闭“自动插入”改为手动选择？若需要，默认策略是否仍为自动插入？
- 片段草稿的命名与标签是否需要与历史记录模块统一规范？
- 通知中心的视觉与排序逻辑是否需要设计团队提供更新规范？
- 是否需要对特定高风险应用（如金融、密码管理器）默认禁用自动插入并给出提示？
