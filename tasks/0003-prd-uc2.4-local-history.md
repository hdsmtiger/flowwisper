# PRD: UC2.4 历史记录本地存储与检索

## 1. 概述
本 PRD 聚焦 Sprint 2 的 UC2.4「历史记录本地存储与检索」。该能力要求桌面端在会话完成后将原始稿与润色稿安全落地到本地加密数据库，保留 48 小时历史，并支持关键词搜索与回溯。通过提供可靠的回放、搜索与复核工具，帮助需要持续输入的桌面端用户快速验证实时转写结果、发现准确性偏差，并在出现识别问题时及时采取补救措施，以整体提升语音转写体验与准确率。

## 2. 目标
1. 在会话结束后 200ms 内触发本地持久化流程，将原始稿、润色稿与会话元数据写入 SQLCipher 数据库，确保落地成功率 ≥ 99.5%。
2. 提供 48 小时内的关键词模糊查询与结果预览，用户可在 1 秒内检索到目标会话并重新复制或插入文本，用于比对与纠错。
3. 自动执行过期清理任务，确保数据库中不保留超过 48 小时的会话文本，同时记录清理日志供诊断。
4. 当用户对历史记录进行二次操作（复制、再次插入、标记准确性）时，保留操作遥测，支撑后续准确率优化与模型调优决策。

## 3. 用户故事
- 作为正在撰写文档的知识工作者，我希望在语音输入结束后，能在历史列表中快速检索到刚才的会话，复制其中的原始稿与润色稿，以便校对并修正文稿。
- 作为经常遇到专有名词识别偏差的用户，我希望历史记录能显示会话元数据（语言、前景应用、时间），并允许我标记“识别不准确”，让团队据此优化词典和模型。
- 作为需要保障隐私的行业用户，我希望所有历史记录仅保留 48 小时并以加密形式存储，确保在设备丢失或共享时不会泄露敏感信息。
- 作为离线工作的用户，我希望即便暂时没有网络，历史记录依旧完整可查，待网络恢复时系统可以同步相关准确性反馈到云端策略服务。

## 4. 功能性需求
1. **会话持久化触发**
   1. 会话从 `Publishing` 进入 `Completed` 时，Core Service 调用持久化层将本次会话写入 SQLCipher，包含原始稿、润色稿、片段操作与准确率信号。
   2. 落地操作需在后台异步执行，并在 200ms 内返回成功/失败结果给 Session Manager；失败时重试最多 2 次并记录错误日志，必要时提示用户保存文本到剪贴板。
2. **存储结构设计**
   1. 建立 `sessions` 表，字段包含：`session_id`、`started_at`、`completed_at`、`duration_ms`、`locale`、`front_app`、`raw_transcript`、`polished_transcript`、`confidence_score`、`post_actions`（JSON，记录插入/复制/草稿保存结果）、`accuracy_flag`（默认 `null`）。
   2. 建立 `session_index` FTS5 索引，对 `raw_transcript`、`polished_transcript`、`front_app` 建立模糊匹配能力，支持中文、英文混合搜索与拼音模糊匹配策略。
   3. 所有文本字段需使用 SQLCipher 的透明加密，并结合架构文档中的密钥管理策略（Secure Enclave/TPM）存储密钥。
3. **历史检索与展示**
   1. 提供桌面端历史面板的 API（后续 UI 迭代使用），支持按关键词、时间范围、语言筛选；默认展示最近 20 条记录及其 120 字预览。
   2. 用户选中历史记录时，可查看完整原始稿/润色稿、复制文本、再次插入当前光标、保存为片段草稿或导出纯文本文件。
   3. 历史详情需展示会话元数据（时间、应用、时长、识别模式、准确率评分），帮助用户判断可能的识别偏差来源。
4. **准确性反馈**
   1. 历史详情中提供“标记识别不准确”“标记润色不满意”等操作，用户可附加简短备注（≤ 140 字）。
   2. 标记结果写入本地数据库并通过 Telemetry 队列排队，待网络可用时同步给云端策略服务；若用户撤销标记，需恢复原状态。
   3. 当同一会话被标记为不准确时，系统提示用户添加自定义词条或上传词典，链接至设置页相关入口。
5. **保留策略与清理**
   1. Core Service 每 30 分钟执行一次 TTL 任务，删除 `completed_at` 超过 48 小时的会话，并清理相关索引与语音缓存分片。
   2. 清理任务需写入操作日志（包括清理数量、耗时、是否成功），供诊断工具查看；若清理失败，记录告警并在下次任务中重试。
6. **错误处理与备份**
   1. 当数据库锁冲突或磁盘空间不足时，系统需暂停写入并提示用户释放空间；同时将当前润色稿复制到剪贴板作为备份。
   2. 如果 SQLCipher 数据库损坏或密钥失效，提供重置流程：清除数据库文件、重新生成密钥，并提示用户历史记录已清空。
   3. 所有失败事件需通过 Telemetry 模块上报，支持后续监控。

## 5. 非目标
- 本迭代不实现跨设备云端同步或团队共享历史记录，所有数据仅限本地设备。
- 不提供语音音频原文件的长期存储或导出，仅保留文本及必要的元数据。
- 不实现高级整理功能（标签、收藏夹、批量导出），仅支持基础搜索与操作。
- 不处理移动端或浏览器插件的历史记录场景。

## 6. 设计考量
- 历史列表与详情界面沿用现有 Tauri 应用的视觉规范，与实时浮层保持一致的色彩与排版层级。
- 搜索输入框需支持中文、英文、拼音与模糊匹配；对于正在输入的搜索词提供即时结果反馈，避免“空列表”造成困惑。
- 在暗色模式下保持良好对比度，尤其是预览文本与状态标签。
- 历史详情中的操作按钮（复制、再次插入、标记准确性）需具备键盘可访问性与屏幕阅读器描述。

## 7. 技术考量
- 复用架构中规划的 SQLCipher + FTS5 方案，采用分区/分片策略，确保 500 条记录内搜索延迟维持在 150ms 以内；必要时可预热索引或维护增量缓存。
- 密钥管理遵循架构文档：在 macOS 使用 Secure Enclave，在 Windows 使用 DPAPI/TPM 缓存密钥分片；应用启动时拉取密钥并放入内存，闲置超过 15 分钟自动清除。
- Persistence Layer 需提供迁移脚本，确保后续从内存队列升级到 SQLCipher 时平滑过渡，旧版本用户更新后自动迁移历史数据结构。
- 清理任务应运行在独立异步任务队列中，避免阻塞主音频管线；建议在 CPU 低负载时执行，并在任务期间限速 I/O。
- Telemetry 事件需包含会话 ID、操作类型、成功/失败状态、耗时、错误码，便于监控准确性与数据库健康度。

## 8. 成功指标
- 95% 的会话在完成后 200ms 内持久化成功，并在 1 秒内可检索到结果。
- 48 小时 TTL 清理覆盖率达到 100%，无超期记录存留；清理任务失败率 < 0.5%。
- 历史搜索请求的 P95 响应时间 < 1 秒，平均响应时间 < 300ms。
- 历史记录中被标记为“不准确”的会话能在 24 小时内同步到遥测管线，供模型或词典优化流程使用；上线后 2 周内，因无法回溯历史导致的用户工单 < 1%。

## 9. 未解问题
- 历史记录 UI 首版是否需同步交付？若暂不交付界面，是否提供命令面板或调试工具访问搜索结果？
- 用户手动导出历史记录是否需要提供（例如导出为加密文件）？
- “准确性标记”是否需要与团队级策略联动（例如自动创建词典建议）？
- 当用户更改历史保留时长（例如延长至 7 天）时，是否需要额外权限或企业策略支持？
